<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emoji Dungeon Crawler</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      display: flex;
    }
    #sidebar {
      width: 200px;
      padding: 10px;
      border-left: 2px solid #0f0;
    }
    #game {
      white-space: pre;
      padding: 10px;
      font-size: 16px;
      line-height: 1.1;
    }
    #command {
      width: 100%;
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 4px;
      font-family: monospace;
      margin-top: 10px;
    }
    select {
      width: 100%;
      margin-bottom: 10px;
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div>
    <select id="themeSelect">
      <option value="fantasy">ğŸ§™ Fantasy</option>
      <option value="scifi">ğŸ¤– Sci-Fi</option>
      <option value="horror">ğŸ§Ÿ Dungeon Horror</option>
    </select>
    <div id="game"></div>
  </div>
  <div id="sidebar">
    <h3>Legend</h3>
    <div id="legend"></div>
    <input id="command" placeholder="e.g. cast ignis" />
  </div>

  <script>
    const roomSize = { width: 20, height: 10 };
    const gameDisplay = document.getElementById("game");
    const commandInput = document.getElementById("command");
    const legendDiv = document.getElementById("legend");
    const themeSelect = document.getElementById("themeSelect");

    let themes = {
      fantasy: {
        player: "ğŸ§™â€â™‚ï¸",
        wall: "ğŸŸ«",
        floor: "â¬›",
        exit: "ğŸšª",
        enemy: "ğŸ‘¹",
        chest: "ğŸ"
      },
      scifi: {
        player: "ğŸ‘¨â€ğŸš€",
        wall: "ğŸ§±",
        floor: "â—¼ï¸",
        exit: "ğŸ›¸",
        enemy: "ğŸ¤–",
        chest: "ğŸ“¦"
      },
      horror: {
        player: "ğŸ§Ÿ",
        wall: "ğŸª¦",
        floor: "â¬œ",
        exit: "ğŸ•³ï¸",
        enemy: "ğŸ•·ï¸",
        chest: "ğŸª™"
      }
    };

    let currentTheme = "fantasy";
    let floorMap = {};
    let currentRoom = '0,0';

    let player = {
      x: 1,
      y: 1,
      hp: 20,
      maxHp: 20,
      exp: 0,
      level: 1,
      inventory: [],
      spells: ['ignis'],
      equipment: {},
      room: '0,0',
    };

    function updateLegend() {
      const t = themes[currentTheme];
      legendDiv.innerHTML = `
        ${t.player} = Player<br>
        ${t.enemy} = Enemy<br>
        ${t.wall} = Wall<br>
        ${t.floor} = Floor<br>
        ${t.exit} = Exit<br>
        ${t.chest} = Chest
      `;
    }

    themeSelect.addEventListener("change", () => {
      currentTheme = themeSelect.value;
      updateLegend();
      renderRoom();
    });

    function createRoom(roomKey) {
      const room = {
        layout: [],
        enemies: [],
        chests: [],
        exits: {}
      };

      for (let y = 0; y < roomSize.height; y++) {
        room.layout[y] = [];
        for (let x = 0; x < roomSize.width; x++) {
          room.layout[y][x] = (y === 0 || x === 0 || y === roomSize.height - 1 || x === roomSize.width - 1) ? "wall" : "floor";
        }
      }

      // Add exits
      const directions = ['north', 'south', 'east', 'west'];
      directions.forEach(dir => {
        if (Math.random() < 0.5 || roomKey === '0,0') {
          let rx = 0, ry = 0, dest = '';
          switch (dir) {
            case 'north': ry = 0; rx = Math.floor(roomSize.width / 2); dest = `${getCoords(roomKey).x},${getCoords(roomKey).y - 1}`; break;
            case 'south': ry = roomSize.height - 1; rx = Math.floor(roomSize.width / 2); dest = `${getCoords(roomKey).x},${getCoords(roomKey).y + 1}`; break;
            case 'west':  rx = 0; ry = Math.floor(roomSize.height / 2); dest = `${getCoords(roomKey).x - 1},${getCoords(roomKey).y}`; break;
            case 'east':  rx = roomSize.width - 1; ry = Math.floor(roomSize.height / 2); dest = `${getCoords(roomKey).x + 1},${getCoords(roomKey).y}`; break;
          }
          room.layout[ry][rx] = "exit";
          room.exits[`${rx},${ry}`] = dest;
        }
      });

      // Add chest
      if (Math.random() < 0.4) {
        const cx = rand(2, roomSize.width - 3);
        const cy = rand(2, roomSize.height - 3);
        room.layout[cy][cx] = "chest";
        room.chests.push({ x: cx, y: cy, contents: randomLoot() });
      }

      // Add enemies
      for (let i = 0; i < 1 + Math.floor(Math.random() * 3); i++) {
        let ex = rand(1, roomSize.width - 2);
        let ey = rand(1, roomSize.height - 2);
        if (room.layout[ey][ex] === "floor") {
          room.enemies.push({ x: ex, y: ey, hp: 5 });
        }
      }

      floorMap[roomKey] = room;
    }

    function getCoords(key) {
      const [x, y] = key.split(',').map(Number);
      return { x, y };
    }

    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function renderRoom() {
      const theme = themes[currentTheme];
      const room = floorMap[player.room];
      let output = '';

      for (let y = 0; y < roomSize.height; y++) {
        for (let x = 0; x < roomSize.width; x++) {
          if (player.x === x && player.y === y) {
            output += theme.player;
          } else if (room.enemies.find(e => e.x === x && e.y === y)) {
            output += theme.enemy;
          } else {
            const tile = room.layout[y][x];
            output += theme[tile] || '?';
          }
        }
        output += '\n';
      }

      output += `HP: ${player.hp}/${player.maxHp}  LVL: ${player.level}  EXP: ${player.exp}`;
      gameDisplay.textContent = output;
    }

    function movePlayer(dx, dy) {
      const room = floorMap[player.room];
      const nx = player.x + dx;
      const ny = player.y + dy;
      const tile = room.layout[ny]?.[nx];

      if (!tile) return;

      if (tile === "exit") {
        const dest = room.exits[`${nx},${ny}`];
        if (!floorMap[dest]) createRoom(dest);
        player.room = dest;
        player.x = roomSize.width - 2;
        player.y = roomSize.height - 2;
        renderRoom();
        return;
      }

      const chest = room.chests.find(c => c.x === nx && c.y === ny);
      if (chest) {
        alert(`You found: ${chest.contents}`);
        if (chest.contents.startsWith("spell: ")) {
          const spell = chest.contents.replace("spell: ", "");
          if (!player.spells.includes(spell)) player.spells.push(spell);
        }
        room.layout[ny][nx] = "floor";
        room.chests = room.chests.filter(c => c !== chest);
      }

      const enemy = room.enemies.find(e => e.x === nx && e.y === ny);
      if (enemy) {
        enemy.hp -= 5;
        player.hp -= 2;
        if (enemy.hp <= 0) {
          room.enemies = room.enemies.filter(e => e !== enemy);
          gainExp(5);
        }
      } else if (tile !== "wall") {
        player.x = nx;
        player.y = ny;
      }

      if (player.hp <= 0) {
        alert("You died!");
        location.reload();
      }

      renderRoom();
    }

    function gainExp(amount) {
      player.exp += amount;
      if (player.exp >= player.level * 10) {
        player.exp = 0;
        player.level++;
        player.maxHp += 5;
        player.hp = player.maxHp;
        alert("Level up!");
      }
    }

    function handleCommand(cmd) {
      const [verb, arg] = cmd.trim().toLowerCase().split(" ");
      if (verb === "cast") {
        if (!player.spells.includes(arg)) {
          alert("Unknown spell.");
        } else if (arg === "ignis") {
          const room = floorMap[player.room];
          room.enemies.forEach(e => {
            if (Math.abs(e.x - player.x) <= 1 && Math.abs(e.y - player.y) <= 1) {
              e.hp -= 10;
            }
          });
          alert("ğŸ”¥ You cast IGNIS!");
        }
      }
      renderRoom();
    }

    function randomLoot() {
      const loot = ["potion", "gold", "spell: lux", "spell: terra", "armor", "weapon"];
      return loot[Math.floor(Math.random() * loot.length)];
    }

    commandInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        handleCommand(commandInput.value);
        commandInput.value = '';
      }
    });

    document.addEventListener("keydown", e => {
      if (document.activeElement === commandInput) return;
      if (e.key === "ArrowUp") movePlayer(0, -1);
      if (e.key === "ArrowDown") movePlayer(0, 1);
      if (e.key === "ArrowLeft") movePlayer(-1, 0);
      if (e.key === "ArrowRight") movePlayer(1, 0);
    });

    // Initial setup
    createRoom(currentRoom);
    updateLegend();
    renderRoom();
  </script>
</body>
</html>
