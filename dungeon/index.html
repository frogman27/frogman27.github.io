<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emoji Dungeon Crawler</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      display: flex;
    }
    #leftPanel {
      display: flex;
      flex-direction: column;
    }
    #game {
      white-space: pre;
      padding: 10px;
      font-size: 16px;
      line-height: 1.2;
    }
    #command {
      width: 100%;
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 4px;
      font-family: monospace;
      margin-top: 10px;
    }
    #sidebar {
      width: 240px;
      padding: 10px;
      border-left: 2px solid #0f0;
    }
    select {
      width: 100%;
      background: #222;
      color: #0f0;
      font-family: monospace;
      margin-bottom: 10px;
    }
    #inventory {
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="leftPanel">
    <select id="themeSelect">
      <option value="fantasy">🧙 Fantasy</option>
      <option value="scifi">🤖 Sci-Fi</option>
      <option value="horror">🧟 Dungeon Horror</option>
    </select>
    <div id="game"></div>
    <input id="command" placeholder="cast ignis east / fire west / equip sword" />
  </div>
  <div id="sidebar">
    <h3>Legend</h3>
    <div id="legend"></div>
    <h4>Inventory</h4>
    <div id="inventory"></div>
  </div>

  <script>
    const roomSize = { width: 20, height: 10 };
    const gameDisplay = document.getElementById("game");
    const commandInput = document.getElementById("command");
    const themeSelect = document.getElementById("themeSelect");
    const legendDiv = document.getElementById("legend");
    const inventoryDiv = document.getElementById("inventory");

    let themes = {
      fantasy: { player: "🧙‍♂️", wall: "🟫", floor: "⬛", exit: "🚪", enemy: "👹", chest: "🎁" },
      scifi:   { player: "👨‍🚀", wall: "🧱", floor: "◼️", exit: "🛸", enemy: "🤖", chest: "📦" },
      horror:  { player: "🧟",   wall: "🪦", floor: "⬜", exit: "🕳️", enemy: "🕷️", chest: "🪙" }
    };
    let currentTheme = "fantasy";

    const directions = {
      north: [0, -1],
      south: [0, 1],
      west: [-1, 0],
      east: [1, 0]
    };

    let floorMap = {}, currentRoom = '0,0';

    let player = {
      x: 1, y: 1, hp: 20, maxHp: 20, exp: 0, level: 1, room: '0,0',
      inventory: ["bow", "sword", "armor", "spell: ignis"],
      spells: ["ignis"],
      weapon: "sword",
      armor: "armor"
    };

    themeSelect.addEventListener("change", () => {
      currentTheme = themeSelect.value;
      updateLegend();
      renderRoom();
    });

    function updateLegend() {
      const t = themes[currentTheme];
      legendDiv.innerHTML = 
        ${t.player} = Player<br>${t.enemy} = Enemy<br>${t.wall} = Wall<br>
        ${t.floor} = Floor<br>${t.exit} = Exit<br>${t.chest} = Chest
      ;
    }

    function renderInventory() {
      inventoryDiv.innerText =
        Weapon: ${player.weapon || "none"}\nArmor: ${player.armor || "none"}\n\nItems:\n +
        player.inventory.join("\n");
    }

    function createRoom(roomKey) {
      const room = { layout: [], enemies: [], chests: [], exits: {} };
      for (let y = 0; y < roomSize.height; y++) {
        room.layout[y] = [];
        for (let x = 0; x < roomSize.width; x++) {
          room.layout[y][x] = (y === 0 || x === 0 || y === roomSize.height - 1 || x === roomSize.width - 1) ? "wall" : "floor";
        }
      }
      for (let dir in directions) {
        if (Math.random() < 0.5 || roomKey === "0,0") {
          let [dx, dy] = directions[dir], cx = 0, cy = 0;
          if (dir === "north") cy = 0, cx = 10;
          if (dir === "south") cy = roomSize.height - 1, cx = 10;
          if (dir === "west") cx = 0, cy = 5;
          if (dir === "east") cx = roomSize.width - 1, cy = 5;
          room.layout[cy][cx] = "exit";
          const [rx, ry] = roomKey.split(',').map(Number);
          room.exits[${cx},${cy}] = ${rx + dx},${ry + dy};
        }
      }
      // Chest
      if (Math.random() < 0.4) {
        let cx = rand(2, roomSize.width - 3), cy = rand(2, roomSize.height - 3);
        room.layout[cy][cx] = "chest";
        room.chests.push({ x: cx, y: cy, contents: randomLoot() });
      }
      // Enemies
      for (let i = 0; i < 2; i++) {
        let ex = rand(1, roomSize.width - 2), ey = rand(1, roomSize.height - 2);
        if (room.layout[ey][ex] === "floor") room.enemies.push({ x: ex, y: ey, hp: 10 });
      }
      floorMap[roomKey] = room;
    }

    function renderRoom() {
      const t = themes[currentTheme], room = floorMap[player.room];
      let output = '';
      for (let y = 0; y < roomSize.height; y++) {
        for (let x = 0; x < roomSize.width; x++) {
          if (player.x === x && player.y === y) output += t.player;
          else if (room.enemies.some(e => e.x === x && e.y === y)) output += t.enemy;
          else output += t[room.layout[y][x]] || '?';
        }
        output += '\n';
      }
      output += HP: ${player.hp}/${player.maxHp}  LVL: ${player.level}  EXP: ${player.exp};
      gameDisplay.textContent = output;
      renderInventory();
    }

    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function move(dx, dy) {
      const room = floorMap[player.room];
      let nx = player.x + dx, ny = player.y + dy;
      const tile = room.layout[ny]?.[nx];
      if (!tile) return;
      const enemy = room.enemies.find(e => e.x === nx && e.y === ny);
      if (enemy) {
        enemy.hp -= 5;
        player.hp -= 1;
        log(You slash the enemy with your ${player.weapon}!);
        if (enemy.hp <= 0) {
          room.enemies = room.enemies.filter(e => e !== enemy);
          gainExp(5);
          log("Enemy defeated!");
        }
      } else if (tile === "exit") {
        let next = room.exits[${nx},${ny}];
        if (!floorMap[next]) createRoom(next);
        player.room = next;
        player.x = roomSize.width - 2;
        player.y = roomSize.height - 2;
      } else if (tile === "chest") {
        let chest = room.chests.find(c => c.x === nx && c.y === ny);
        if (chest) {
          log(You found: ${chest.contents});
          player.inventory.push(chest.contents);
          if (chest.contents.startsWith("spell: ")) {
            let spell = chest.contents.split(": ")[1];
            if (!player.spells.includes(spell)) player.spells.push(spell);
          }
          room.layout[ny][nx] = "floor";
          room.chests = room.chests.filter(c => c !== chest);
        }
        player.x = nx; player.y = ny;
      } else if (tile !== "wall") {
        player.x = nx; player.y = ny;
      }
      renderRoom();
    }

    function gainExp(xp) {
      player.exp += xp;
      if (player.exp >= player.level * 10) {
        player.exp = 0;
        player.level++;
        player.maxHp += 5;
        player.hp = player.maxHp;
        log("You leveled up!");
      }
    }

    function fireProjectile(dx, dy, damage, type) {
      const room = floorMap[player.room];
      let x = player.x + dx, y = player.y + dy;
      while (room.layout[y]?.[x] && room.layout[y][x] !== "wall") {
        const enemy = room.enemies.find(e => e.x === x && e.y === y);
        if (enemy) {
          enemy.hp -= damage;
          log(Your ${type} hits an enemy for ${damage} damage!);
          if (enemy.hp <= 0) {
            room.enemies = room.enemies.filter(e => e !== enemy);
            gainExp(5);
          }
          break;
        }
        x += dx; y += dy;
      }
      renderRoom();
    }

    function handleCommand(cmd) {
      let args = cmd.trim().toLowerCase().split(" ");
      if (args[0] === "cast") {
        let spell = args[1], dir = args[2];
        if (!player.spells.includes(spell)) return log("You don't know that spell.");
        if (!directions[dir]) return log("Invalid direction.");
        if (spell === "ignis") {
          let [dx, dy] = directions[dir];
          log("You cast 🔥 IGNIS!");
          fireProjectile(dx, dy, 10, "fireball");
        }
      } else if (args[0] === "fire") {
        let dir = args[1];
        if (!directions[dir]) return log("Invalid direction.");
        let [dx, dy] = directions[dir];
        log(You fire your ${player.weapon || "ranged weapon"} ➡️);
        fireProjectile(dx, dy, 5, "arrow");
      } else if (args[0] === "equip") {
        let item = args[1];
        if (player.inventory.includes(item)) {
          if (["sword", "bow", "axe"].includes(item)) player.weapon = item;
          if (["armor", "cloak"].includes(item)) player.armor = item;
          log(You equipped ${item}.);
        } else {
          log("You don't have that item.");
        }
      }
    }

    function log(msg) {
      console.log(msg);
    }

    commandInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        handleCommand(commandInput.value);
        commandInput.value = '';
      }
    });

    document.addEventListener("keydown", e => {
      if (document.activeElement === commandInput) return;
      if (e.key === "ArrowUp") move(0, -1);
      if (e.key === "ArrowDown") move(0, 1);
      if (e.key === "ArrowLeft") move(-1, 0);
      if (e.key === "ArrowRight") move(1, 0);
    });

    function randomLoot() {
      const pool = ["potion", "gold", "armor", "cloak", "sword", "bow", "spell: ignis", "spell: lux"];
      return pool[rand(0, pool.length - 1)];
    }

    // INIT
    createRoom(currentRoom);
    updateLegend();
    renderRoom();
  </script>
</body>
</html>